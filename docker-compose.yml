services:
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./docker/nginx/nginx.vhost.dev.conf.template:/etc/nginx/conf.d/nginx.vhost.dev.conf.template:ro
      - ./docker/nginx/nginx.vhost.prod.conf.template:/etc/nginx/conf.d/nginx.vhost.prod.conf.template:ro
      - ./docker/nginx/nginx-entrypoint.sh:/nginx-entrypoint.sh
    entrypoint: ["sh", "-c", "chmod +x /nginx-entrypoint.sh && exec /nginx-entrypoint.sh"]
    depends_on:
      - frontend
      - backend
    networks:
      - mangareader
    environment:
      - VHOST_DOMAIN=${VHOST_DOMAIN}
      - FRONTEND_PORT=${FRONTEND_PORT}
      - BACKEND_PORT=${BACKEND_PORT}
      - APP_MODE=${APP_MODE}
      
  # Frontend service - builds for production or runs dev server
  frontend:
    build:
      context: ./frontend
      dockerfile: ../Dockerfile.frontend
      target: builder
    ports:
      - "${FRONTEND_PORT:-5173}:${FRONTEND_PORT:-5173}"
    volumes:
      - frontend-dist:/app/dist
      - ./frontend:/app:cached
      - /app/node_modules
    environment:
      - NODE_ENV=${APP_MODE:-production}
      - APP_MODE=${APP_MODE:-production}
      - FRONTEND_PORT=${FRONTEND_PORT:-5173}
      - BACKEND_PORT=${BACKEND_PORT:-3000}
    command: >
      sh -c "
        if [ \"$$APP_MODE\" = \"development\" ]; then
          npm run dev -- --host 0.0.0.0;
        else
          npm run build && echo 'Frontend built successfully';
        fi
      "
    networks:
      - mangareader

  # Backend service - serves API and frontend
  backend:
    build:
      context: ./backend
      dockerfile: ../Dockerfile.backend
      args:
        - BACKEND_PORT=${BACKEND_PORT:-3000}
    ports:
      - "${BACKEND_PORT:-3000}:${BACKEND_PORT:-3000}"
    environment:
      - NODE_ENV=${APP_MODE:-production}
      - PORT=${BACKEND_PORT:-3000}
      - DATABASE_URL=file:/data/dev.db
      - MANGA_STORAGE_PATH=/manga
    volumes:
      - frontend-dist:/app/frontend/dist:ro
      - backend-data:/data
      - ./storage/images:/app/images
      - manga-storage:/manga:ro
      - ./backend/src:/app/src
    depends_on:
      - frontend
    restart: unless-stopped
    command: >
      sh -c "
        npx prisma migrate deploy &&
        if [ \"$$APP_MODE\" = \"development\" ]; then
          npm run dev;
        else
          node dist/index.js;
        fi
      "
    networks:
      - mangareader

volumes:
  frontend-dist:
  backend-data:

  manga-storage:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MANGA_STORAGE_PATH:-/mnt/d/Manhwa}

networks:
  mangareader:
    driver: bridge
