services:
  # Frontend service - builds for production or runs dev server
  frontend:
    build:
      context: ./frontend
      dockerfile: ../Dockerfile.frontend
      target: builder
    ports:
      - "5173:5173"
    volumes:
      - frontend-dist:/app/dist
      - ./frontend:/app:cached
      - /app/node_modules
    environment:
      - NODE_ENV=${APP_MODE:-production}
      - APP_MODE=${APP_MODE:-production}
    command: >
      sh -c "
        if [ \"$$APP_MODE\" = \"development\" ]; then
          npm run dev -- --host 0.0.0.0;
        else
          npm run build && echo 'Frontend built successfully';
        fi
      "

  # Backend service - serves API and frontend
  backend:
    build:
      context: ./backend
      dockerfile: ../Dockerfile.backend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DATABASE_URL=file:/data/dev.db
      - MANGA_STORAGE_PATH=/manga
    volumes:
      - frontend-dist:/app/frontend/dist:ro
      - backend-data:/data
      - ./images:/app/images:ro
      - manga-storage:/manga:ro
    depends_on:
      - frontend
    restart: unless-stopped
    command: >
      sh -c "
        npx prisma migrate deploy &&
        node dist/index.js
      "

volumes:
  frontend-dist:
  backend-data:
  # Manga storage volume - mounts host directory specified in MANGA_STORAGE_PATH (.env)
  # Default path: /mnt/d/Manhwa (host) -> /manga (container)
  # To change the host path, update MANGA_STORAGE_PATH in .env file
  manga-storage:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MANGA_STORAGE_PATH:-/mnt/d/Manhwa}
